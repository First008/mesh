# MESH Gateway - Single Container for Multiple Repositories
# This docker-compose file replaces the multi-container setup with a single gateway
# that manages all repositories with branch-aware incremental indexing

name: mesh

# Docker Compose now in project root alongside .env file
# This ensures proper .env variable substitution

services:
  # Single gateway managing all repositories
  mesh-gateway:
    build:
      context: .
      dockerfile: deployments/docker/Dockerfile.agent
    container_name: mesh-gateway
    env_file:
      - .env # Load environment variables from same directory
    ports:
      - "9000:9000" # Gateway HTTP API
    volumes:
      # Mount entire platform directory (read-only)
      - ${BASE_DIR:-../../..}:/repos:ro
      # Mount gateway configuration
      - ./configs/repos.yaml:/config.yaml:ro
      # Persistent metadata for branch tracking
      - mesh-metadata:/app/.mesh
    environment:
      - MODE=gateway
      - ANTHROPIC_API_KEY # Pass through from .env file
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      - qdrant
    entrypoint:
      ["/bin/sh", "-c", "sleep 3 && /app/mesh-agent -config /config.yaml"]
    networks:
      - mesh-network
    restart: unless-stopped

  # Single Qdrant instance with multiple collections (one per repo+branch)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: mesh-qdrant
    ports:
      - "6333:6333" # HTTP API
      - "6334:6334" # gRPC API
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - mesh-network
    restart: unless-stopped

networks:
  mesh-network:
    driver: bridge

volumes:
  qdrant-data:
    driver: local
  mesh-metadata:
    driver: local
